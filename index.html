<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coli Sphericus</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶†</text></svg>">
    <link rel="stylesheet" type="text/css" href="./web/style.css">
</head>
<body>
    <a id="downloader" target="_blank" download="data.csv" hidden></a>

    <div id="control-panel">
        <button
            class="control important-control"
            onclick="startDrawing()">
                –ú–∞–ª—é–π!
        </button>

        <button class="control" onclick="stopDrawing()">–°—Ç–æ–ø!</button>

        <button class="control" onclick="clearDrawing()">–û—á–∏—Å—Ç–∏—Ç–∏</button>

        <div class="control">
            <span>—à–≤–∏–¥–∫—ñ—Å—Ç—å:</span>
            <input class="control" id="speed" type="number" value="1"/>
            <span>–º–º/—Å</span>
        </div>

        <div class="control">
            <span>—á–∞—Å:</span>
            <input class="control" id="time" type="number" value="15"/>
            <span>—Ö–≤</span>
        </div>

        <button class="control" onclick="toggleParams()">–û–ø—Ü—ñ—ó ‚ñº</button>
        <div id="paramList" class="param-list-wrapper hidden">
            <ul class="param-list">
                <li class="param"><input type="checkbox" id="param_bounded" checked>
                    –ù–µ –≤–∏—Ö–æ–¥–∏—Ç–∏ –∑–∞ –º–µ–∂—ñ
                </input></li>
                <li class="param"><input type="checkbox" id="param_wait">
                    –î–æ—á–µ–∫–∞—Ç–∏—Å—è –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ä–æ—Å—Ç—É –∫–æ–ª–æ–Ω—ñ–π
                </input></li>
                <li class="param"><input type="checkbox" id="param_hungry">
                    –ì–æ–ª–æ–¥–Ω—ñ –∫–æ–ª–æ–Ω—ñ—ó
                </input></li>

                <li class="param">
                    <span>–í–±–∏–≤—á–∞ –¥–æ–∑–∞ —Å—É—Å—ñ–¥—ñ–≤: </span>
                    <input type="number" id="param_neighbour_limit" value="5"/>
                </li>

                <br/>

                <li class="param">
                    –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ:
                </li>
                <li class="param"><input type="checkbox" id="param_gen_St">
                    S<sub>–∑–∞–≥–∞–ª—å–Ω–∞</sub>(t)
                </input></li>
                <li class="param"><input type="checkbox" id="param_gen_Nt">
                    N<sub>–∞–∫—Ç–∏–≤–Ω–∏—Ö</sub>(t)
                </input></li>
                <li class="param"><input type="checkbox" id="param_gen_Tt">
                    T<sub>–∂–∏—Ç—Ç—è –∫–æ–ª–æ–Ω—ñ–π</sub>(t)
                </input></li>

                <br/>

                <li class="param">
                    <span>–ó–¥—ñ–π—Å–Ω—é–≤–∞—Ç–∏ —ñ—Ç–µ—Ä–∞—Ü—ñ–π –¥–ª—è –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è 1 —Å–µ–∫—É–Ω–¥–∏: </span>
                    <input type="number" id="param_iter_per_sec" value="2"/>
                </li>
                <li class="param">
                    <span>–ß–∞—Å—Ç–æ—Ç–∞: </span>
                    <input type="number" id="param_freq" value="20"/>
                    <span>—ñ—Ç–µ—Ä–∞—Ü—ñ–π –∑–∞ —Å–µ–∫—É–Ω–¥—É</span>
                </li>
            </ul>

        </div>
            
        <button class="control" onclick="downloadData()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ</button>
    </div>

    <main>
        <canvas id="canvas" width="1000" height="1000">
            HTML5 is required by this page but is not supported by your browser.
        </canvas>
    </main>

    <script>
        function toggleParams() {
            document.getElementById('paramList').classList.toggle('hidden');
        }
    </script>

    <script type="module">
        import {default as init_wasm, CircleDrawer} from './wasm/wasm.js';
        
        var drawer;
        
        async function load_wasm() {
            await init_wasm();
            drawer = new CircleDrawer();
        }
        load_wasm();
        
        function step() {
            drawer.draw();
            if (drawer.is_finished())
                window.stopDrawing();
        }
        
        function isChecked(checkboxId) {
            return document.getElementById(checkboxId).checked;
        }

        function getNum(inputId) {
            return Number.parseFloat(document.getElementById(inputId).value);
        }

        window.drawingIntervalObject = null;
        window.startDrawing = function() {
            if (getNum('param_iter_per_sec') == 0) {
                alert('–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π –∑–∞ —Å–µ–∫—É–Ω–¥—É –Ω–µ –º–∞—î –±—É—Ç–∏ 0!!!');
                return;
            }

            if (getNum('param_freq') == 0) {
                alert('–ß–∞—Å—Ç–æ—Ç–∞ –Ω–µ –º–∞—î –±—É—Ç–∏ 0!!!');
                return;
            }

            drawer.set_iter_per_sec(getNum('param_iter_per_sec'));
            drawer.set_speed(getNum('speed')); 
            drawer.set_time(getNum('time') * 60); // Minutes -> seconds
            drawer.set_bounded(isChecked('param_bounded'));
            drawer.set_should_wait_until_end(isChecked('param_wait'));
            drawer.set_hungry(isChecked('param_hungry'));
            drawer.set_neighbour_limit(getNum('param_neighbour_limit'));

            drawer.set_gen_S(isChecked('param_gen_St'));
            drawer.set_gen_N(isChecked('param_gen_Nt'));
            drawer.set_gen_T(isChecked('param_gen_Tt'));

            if (window.drawingIntervalObject === null)
                window.drawingIntervalObject =
                    setInterval(step, 1000. / getNum('param_freq'));
        };

        window.stopDrawing = function() {
            if (window.drawingIntervalObject !== null) {
                clearInterval(window.drawingIntervalObject);
                window.drawingIntervalObject = null;
            }
        };

        window.clearDrawing = function() {
            if (confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏?"))
                drawer.clear();
        };

        window.downloadData = function() {
            let need_S = isChecked('param_gen_St');
            let need_N = isChecked('param_gen_Nt');
            let need_T = isChecked('param_gen_Tt');
            let S = drawer.get_data_S();
            let N = drawer.get_data_N();
            let T = drawer.get_data_T();
            let csv = '';

            csv += '"t"';
            if (need_S) csv += ',"S [–º¬≤]"';
            if (need_N) csv += ',"N –∞–∫—Ç–∏–≤–Ω–∏—Ö"';
            if (need_T) csv += ',"T –∂–∏—Ç—Ç—è [—Å]"';
            csv += '\n';

            let dataLength = Math.max(S.length, N.length, T.length);
            for (let t=0; t<dataLength; t++) {
                csv += t;
                if (need_S) csv += ',' + S[t];
                if (need_N) csv += ',' + N[t];
                if (need_T) csv += ',' + T[t];
                csv += '\n';
            }

            let downloader = document.getElementById('downloader');
            downloader.href = 'data:attachment/text,' + encodeURI(csv);
            downloader.click();
            
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coli Sphericus</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶†</text></svg>">
    <link rel="stylesheet" type="text/css" href="./web/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
</head>

<body>
    <a id="downloader" target="_blank" download="data.csv" hidden></a>

    <div class="navbar navbar-expand-sm navbar-light bg-light position-absolute top-0"
        style="width: 100vw; height: 7vh; box-shadow: 0px 0.5px 5px 0px grey;">
        <div class="container-fluid align-items-center">
            <button class="btn btn-success d-flex flex-row align-items-center m-2" onclick="startDrawing()">
                –°—Ç–∞—Ä—Ç<i class="bi-play-fill" style="font-size: 1.5em; line-height: 1em; margin-left: 5px;"></i>
            </button>

            <button class="btn btn-primary d-flex align-items-center m-2" onclick="stopDrawing()">–°—Ç–æ–ø<i
                    class="bi-stop-fill" style="font-size: 1.5em; line-height: 1em; margin-left: 5px;"></i></button>

            <button class="btn btn-danger d-flex align-items-center m-2" onclick="clearDrawing()">–û—á–∏—Å—Ç–∏—Ç–∏<i
                    class="bi-arrow-counterclockwise"
                    style="font-size: 1.5em; line-height: 1em; margin-left: 5px;"></i></button>

            <button id="popbtn" class="btn btn-secondary d-flex align-items-center m-2" data-bs-toggle="popover"
                data-bs-placement="bottom">–û–ø—Ü—ñ—ó<i class="bi-gear-fill"
                    style="font-size: 1.1em; line-height: 1em; margin-left: 5px;"></i></button>

            <div class="input-group m-2">
                <span class="input-group-text">—à–≤–∏–¥–∫—ñ—Å—Ç—å:</span>
                <input class="form-control" id="speed" type="number" value="1">
                <span class="input-group-text">–º–º/—Å</span>
            </div>

            <div class="input-group m-2">
                <span class="input-group-text">—á–∞—Å:</span>
                <input class="form-control" id="time" type="number" value="15">
                <span class="input-group-text">—Ö–≤</span>
            </div>

            <div style="display: none; visibility: hidden;">
                <div id="popover" class="param-list-wrapper">
                    <form>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_bounded">
                            <label class="form-check-label" for="param_bounded">–ù–µ –≤–∏—Ö–æ–¥–∏—Ç–∏ –∑–∞ –º–µ–∂—ñ</label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_wait">
                            <label class="form-check-label" for="param_wait">–î–æ—á–µ–∫–∞—Ç–∏—Å—è –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ä–æ—Å—Ç—É –∫–æ–ª–æ–Ω—ñ–π</label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_hungry">
                            <label class="form-check-label" for="param_hungry">–ì–æ–ª–æ–¥–Ω—ñ –∫–æ–ª–æ–Ω—ñ—ó</label>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_zalpha">
                            <label class="form-check-label" for="param_zalpha">–ü—Ä–æ–∑–æ—Ä—ñ —Å—Ñ–µ—Ä–∏</label>
                        </div>

                        <br>

                        <div>
                            <label for="param_neighbour_limit" class="form-label">–í–±–∏–≤—á–∞ –¥–æ–∑–∞ —Å—É—Å—ñ–¥—ñ–≤:</label>
                            <input type="number" class="form-control" id="param_neighbour_limit" value="5">
                        </div>

                        <br>


                        –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ:
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_gen_St">
                            <label class="form-check-label" for="param_gen_St">S<sub>–∑–∞–≥–∞–ª—å–Ω–∞</sub>(t)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_gen_Nt">
                            <label class="form-check-label" for="param_gen_Nt">N<sub>–∞–∫—Ç–∏–≤–Ω–∏—Ö</sub>(t)</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="param_gen_Tt">
                            <label class="form-check-label" for="param_gen_Tt">T<sub>–∂–∏—Ç—Ç—è –∫–æ–ª–æ–Ω—ñ–π</sub>(t)</label>
                        </div>

                        <br />

                        <div>
                            <label for="param_dim" class="form-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–º—ñ—Ä—ñ–≤:</label>
                            <input type="number" class="form-control" id="param_dim" value="2">
                        </div>
                        <div class="mt-2">
                            <label for="param_iter_per_sec" class="form-label">–ó–¥—ñ–π—Å–Ω—é–≤–∞—Ç–∏ —ñ—Ç–µ—Ä–∞—Ü—ñ–π –¥–ª—è –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è 1
                                —Å–µ–∫—É–Ω–¥–∏:</label>
                            <input type="number" class="form-control" id="param_iter_per_sec" value="2">
                        </div>
                        <div class="mt-2">
                            <label for="param_freq" class="form-label">–ß–∞—Å—Ç–æ—Ç–∞ (—ñ—Ç–µ—Ä–∞—Ü—ñ–π –∑–∞ —Å–µ–∫—É–Ω–¥—É):</label>
                            <input type="number" class="form-control" id="param_freq" value="20">
                        </div>
                    </form>

                </div>
            </div>

            <button class="btn btn-outline-primary d-flex flex-row align-items-center justify-content-between m-2"
                title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ"
                onclick="downloadData()"><i class="bi-download"
                    style="font-size: 1.2em; line-height: 1em;"></i> <!-- margin-right: 5px; -->
                    <!-- <span style="white-space: nowrap;">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ</span> -->
            </button>
        </div>
    </div>


    <canvas class="mt-3" style="
            width: min(70vw, 70vh);
            background-color: whitesmoke;
            border-radius: 5px;
            border: 0.5px lightgrey solid;
            box-shadow: inset 0px 0px 2px 2px lightgrey;
            " id="canvas" width="1000" height="1000">
        HTML5 is required by this page but is not supported by your browser.
    </canvas>

    <script type="module">
        import { default as init_wasm, CircleDrawer } from './wasm/wasm.js';

        let param_gen_St
        let param_gen_Nt
        let param_gen_Tt
        let param_iter_per_sec
        let speed
        let time
        let param_bounded
        let param_wait
        let param_hungry
        let param_neighbour_limit
        let param_freq
        let param_dim
        let param_zalpha

        function isChecked(checkboxId) {
            return document.getElementById(checkboxId).checked;
        }

        function getNum(inputId) {
            return Number.parseFloat(document.getElementById(inputId).value);
        }

        function readParams() {
            param_gen_St = isChecked('param_gen_St')
            param_gen_Nt = isChecked('param_gen_Nt')
            param_gen_Tt = isChecked('param_gen_Tt')
            param_iter_per_sec = getNum('param_iter_per_sec')
            speed = getNum('speed')
            time = getNum('time')
            param_bounded = isChecked('param_bounded')
            param_wait = isChecked('param_wait')
            param_hungry = isChecked('param_hungry')
            param_neighbour_limit = getNum('param_neighbour_limit')
            param_freq = getNum('param_freq')
            param_dim = getNum('param_dim')
            param_zalpha = isChecked('param_zalpha')

            console.log('Mode: ' + param_dim + 'D')
        }

        window.onload = () => {
            readParams();

            let popbtn = document.getElementById('popbtn')

            new bootstrap.Popover(
                popbtn,
                {
                    html: true,
                    content: document.getElementById('popover')
                }
            );

            popbtn.addEventListener('inserted.bs.popover', () => {
                readParams();
            });

            popbtn.addEventListener('hide.bs.popover', () => {
                readParams();
            });
        }

        var drawer;

        async function load_wasm() {
            await init_wasm();
            drawer = new CircleDrawer();
        }
        load_wasm();

        function step() {
            drawer.draw();
            if (drawer.is_finished())
                window.stopDrawing();
        }

        window.drawingIntervalObject = null;
        window.startDrawing = function () {
            if (param_iter_per_sec == 0) {
                alert('–ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π –∑–∞ —Å–µ–∫—É–Ω–¥—É –Ω–µ –º–∞—î –±—É—Ç–∏ 0!!!');
                return;
            }

            if (param_freq == 0) {
                alert('–ß–∞—Å—Ç–æ—Ç–∞ –Ω–µ –º–∞—î –±—É—Ç–∏ 0!!!');
                return;
            }

            drawer.set_iter_per_sec(param_iter_per_sec);
            drawer.set_speed(speed);
            drawer.set_time(time * 60); // Minutes -> seconds
            drawer.set_bounded(param_bounded);
            drawer.set_should_wait_until_end(param_wait);
            drawer.set_hungry(param_hungry);
            drawer.set_neighbour_limit(param_neighbour_limit);

            drawer.set_gen_S(param_gen_St);
            drawer.set_gen_N(param_gen_Nt);
            drawer.set_gen_T(param_gen_Tt);

            drawer.set_dimensions(param_dim);
            drawer.set_use_z_alpha(param_zalpha);

            if (window.drawingIntervalObject === null)
                window.drawingIntervalObject =
                    setInterval(step, 1000. / param_freq);
        };

        window.stopDrawing = function () {
            if (window.drawingIntervalObject !== null) {
                clearInterval(window.drawingIntervalObject);
                window.drawingIntervalObject = null;
            }
        };

        window.clearDrawing = function () {
            if (confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–∏?"))
                drawer.clear();
        };

        window.downloadData = function () {
            let need_S = param_gen_St;
            let need_N = param_gen_Nt;
            let need_T = param_gen_Tt;
            let S = drawer.get_data_S();
            let N = drawer.get_data_N();
            let T = drawer.get_data_T();
            let csv = '';

            csv += '"t"';
            if (need_S) csv += ',"S [–º¬≤]"';
            if (need_N) csv += ',"N –∞–∫—Ç–∏–≤–Ω–∏—Ö"';
            if (need_T) csv += ',"T –∂–∏—Ç—Ç—è [—Å]"';
            csv += '\n';

            let dataLength = Math.max(S.length, N.length, T.length);
            for (let t = 0; t < dataLength; t++) {
                csv += t;
                if (need_S) csv += ',' + S[t];
                if (need_N) csv += ',' + N[t];
                if (need_T) csv += ',' + T[t];
                csv += '\n';
            }

            let downloader = document.getElementById('downloader');
            downloader.href = 'data:attachment/text,' + encodeURI(csv);
            downloader.click();

        };
    </script>
</body>

</html>